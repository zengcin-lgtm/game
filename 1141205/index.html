<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>阿美族語小遊戲 - O maan kinian?</title>
    <!-- 使用 Tailwind CSS 進行快速排版 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 FontAwesome 圖示 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* 字體設定 */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23e5e7eb' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        /* 阿美族風格配色與邊框 */
        .amis-border {
            border: 8px solid #E3002D; /* 阿美紅 */
            position: relative;
            background-color: white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .amis-header {
            background: #E3002D;
            color: white;
            position: relative;
            overflow: hidden;
        }

        /* 模擬原住民編織圖騰的裝飾線條 */
        .weaving-pattern {
            height: 20px;
            width: 100%;
            background-image: 
                linear-gradient(135deg, #000000 25%, transparent 25%), 
                linear-gradient(225deg, #000000 25%, transparent 25%), 
                linear-gradient(45deg, #000000 25%, transparent 25%), 
                linear-gradient(315deg, #000000 25%, transparent 25%);
            background-position: 10px 0, 10px 0, 0 0, 0 0;
            background-size: 20px 20px;
            background-repeat: repeat-x;
            background-color: #ffffff;
            opacity: 0.8;
        }

        .btn-option {
            transition: all 0.3s ease;
        }
        
        .btn-option-clickable {
            cursor: pointer;
        }
        .btn-option-clickable:active {
            transform: scale(0.95);
        }

        .btn-audio {
            background-color: #FBBF24; /* 黃色裝飾 */
            color: #1F2937;
            border-bottom: 4px solid #D97706;
        }
        .btn-audio:active {
            border-bottom: 0px solid #D97706;
            transform: translateY(4px);
        }

        /* 圖片佔位符樣式 */
        .img-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #e5e7eb;
            color: #9ca3af;
            font-size: 3rem;
            width: 100%;
            height: 200px;
            border-radius: 0.5rem;
        }

        .game-img {
            width: 100%;
            height: 200px;
            object-fit: contain; 
            background-color: #f9fafb;
            border-radius: 0.5rem;
            border: 2px solid #e5e7eb;
        }

        .feedback-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 50;
            font-size: 10rem;
            background: rgba(255,255,255,0.7);
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 錄音動畫 */
        .recording-pulse {
            animation: pulse-red 1.5s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(227, 0, 45, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(227, 0, 45, 0); }
            100% { box-shadow: 0 0 0 0 rgba(227, 0, 45, 0); }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- 主遊戲容器 -->
    <div class="w-full max-w-2xl amis-border rounded-xl overflow-hidden fade-in">
        
        <!-- 頂部標題區 -->
        <div class="amis-header p-6 text-center">
            <h1 class="text-3xl font-bold mb-2">阿美族語小教室</h1>
            <p class="text-sm opacity-90">O maan kinian? (這是什麼？)</p>
            <div class="absolute top-0 left-0 w-full h-2 bg-black"></div>
            <div class="absolute bottom-0 left-0 w-full h-2 bg-white opacity-20"></div>
        </div>
        <div class="weaving-pattern"></div>

        <!-- 遊戲內容區 -->
        <div id="game-container" class="p-6 bg-white min-h-[400px] flex flex-col relative">
            
            <!-- 計分板 (登入畫面隱藏) -->
            <div id="score-board" class="flex justify-between items-center mb-6 text-lg font-bold text-gray-700 hidden">
                <span id="level-indicator">準備開始</span>
                <span class="bg-red-100 text-red-600 px-4 py-1 rounded-full">分數: <span id="score-display">0</span></span>
            </div>

            <!-- 1. 登入畫面 (輸入名字) -->
            <div id="screen-login" class="flex flex-col items-center justify-center flex-grow text-center space-y-6">
                <div class="text-6xl text-red-600 mb-4">
                    <i class="fa-solid fa-shapes"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Cima kiso? 你是誰？</h2>
                <p class="text-gray-600">輸入名字後，我們就開始遊戲囉！</p>
                <input type="text" id="student-name" placeholder="例如：陳小明" class="border-2 border-gray-300 rounded-lg p-3 w-full max-w-xs text-center text-xl focus:border-red-500 outline-none">
                <button onclick="game.start()" class="bg-amis-red text-white text-xl font-bold py-4 px-12 rounded-full shadow-lg transform transition hover:scale-105 active:scale-95">
                    開始遊戲
                </button>
            </div>

            <!-- 2. 遊戲進行畫面 (Phase 1 & 2) -->
            <div id="quiz-screen" class="hidden flex flex-col flex-grow w-full">
                <!-- 題目區 -->
                <div id="question-area" class="flex flex-col items-center justify-center mb-8">
                    <!-- 動態插入內容 -->
                </div>
                <!-- 選項區 -->
                <div id="options-area" class="grid grid-cols-2 gap-4">
                    <!-- 動態插入選項 -->
                </div>
            </div>

            <!-- 3. 口說練習畫面 (Phase 3) -->
            <div id="speaking-screen" class="hidden flex flex-col flex-grow w-full items-center">
                <h3 class="text-xl font-bold text-gray-800 mb-4 text-center w-full bg-yellow-100 py-2 rounded-lg">
                    <i class="fa-solid fa-microphone mr-2"></i>口說練習 (錄下回答)
                </h3>
                
                <!-- 題目圖片 -->
                <div class="w-full max-w-xs h-48 bg-gray-100 rounded-xl mb-4 overflow-hidden border-2 border-gray-200 flex items-center justify-center relative">
                    <img id="sp-image" src="" class="w-full h-full object-contain">
                </div>

                <!-- 聽問題按鈕 -->
                <button onclick="game.playCurrentSpeakingQuestion()" class="w-full bg-gray-800 text-white py-3 rounded-lg shadow hover:bg-black transition flex items-center justify-center mb-6">
                    <i class="fa-solid fa-ear-listen mr-2"></i> 聽老師的問題
                </button>

                <!-- 錄音區塊 -->
                <div class="flex flex-col items-center w-full bg-red-50 rounded-xl p-4 border border-red-100">
                    <p class="text-gray-600 mb-4 font-bold" id="sp-status-text">按住按鈕錄音回答</p>
                    
                    <!-- 錄音按鈕 -->
                    <button id="btn-record" class="w-20 h-20 bg-red-600 rounded-full text-white text-3xl shadow-lg flex items-center justify-center transition-all hover:scale-110 active:scale-95">
                        <i class="fa-solid fa-microphone"></i>
                    </button>

                    <!-- 錄音完成後的控制項 -->
                    <div id="sp-controls" class="hidden flex space-x-4 mt-4 w-full">
                        <button onclick="game.playRecording()" class="flex-1 bg-yellow-400 text-gray-800 py-2 rounded-lg font-bold hover:bg-yellow-500">
                            <i class="fa-solid fa-play mr-1"></i> 試聽
                        </button>
                        <button onclick="game.uploadRecording()" class="flex-1 bg-green-500 text-white py-2 rounded-lg font-bold hover:bg-green-600 shadow-md">
                            <i class="fa-solid fa-paper-plane mr-1"></i> 送出
                        </button>
                    </div>
                    
                    <button id="btn-retry" class="hidden text-gray-400 text-sm mt-3 underline" onclick="game.resetRecording()">不滿意？重錄</button>
                </div>
            </div>

            <!-- 4. 上傳中畫面 -->
            <div id="screen-loading" class="hidden flex flex-col items-center py-10 justify-center flex-grow">
                <i class="fa-solid fa-circle-notch fa-spin text-6xl text-amis-red mb-4"></i>
                <h3 class="text-xl font-bold text-gray-800">正在傳送作業...</h3>
            </div>

            <!-- 5. 結算畫面 -->
            <div id="result-screen" class="hidden flex flex-col items-center justify-center flex-grow text-center space-y-6">
                <div id="result-icon" class="text-6xl text-yellow-500 mb-2">
                    <i class="fa-solid fa-trophy"></i>
                </div>
                <h2 class="text-3xl font-bold text-gray-800">遊戲結束！</h2>
                <div class="text-xl">
                    你的總得分是：<br>
                    <span id="final-score" class="text-5xl font-bold text-red-600 my-4 block">0</span>
                </div>
                <p id="feedback-text" class="text-gray-600">很棒喔！</p>
                
                <div class="flex flex-col space-y-4 w-full max-w-xs mt-4">
                    <button onclick="location.reload()" class="bg-gray-800 hover:bg-gray-900 text-white text-lg font-bold py-3 px-8 rounded-full shadow-lg transform transition hover:scale-105 active:scale-95">
                        再玩一次
                    </button>
                    <a href="index.html" class="bg-white border-2 border-gray-300 hover:border-red-500 text-gray-600 hover:text-red-600 text-lg font-bold py-3 px-8 rounded-full shadow-md text-center transform transition hover:scale-105 active:scale-95 flex items-center justify-center">
                        <i class="fa-solid fa-house mr-2"></i>回首頁
                    </a>
                </div>
            </div>

        </div>
    </div>

    <!-- 答題回饋 (O/X) -->
    <div id="feedback-overlay" class="feedback-overlay">
        <i id="feedback-icon" class="fa-solid"></i>
    </div>

    <!-- 隱藏的音效播放器 -->
    <audio id="audio-player"></audio>
    <audio id="sfx-correct" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>
    <audio id="sfx-wrong" src="https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3"></audio>

    <script>
        // ==========================================
        // 設定區
        // ==========================================
        
        // 請在此填入您的 Google Apps Script 網址
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxNxCe65GHUdvHGcVKgKMz8G1Gy88GLkg2cIJKGzkUuWvKe-FXiMCDOcflqoK-PgwgnZg/exec"; 

        const assets = {
            // 單字資料庫
            items: [
                {
                    id: 'tamohong',
                    name: 'tamohong', 
                    chinese: '帽子',
                    image: 'images/tamohong.jpg', 
                    audio_word: 'audio/tamohong.wav',
                    audio_sentence: 'audio/sentence_tamohong.wav'
                },
                {
                    id: 'fodoy',
                    name: 'fodoy',
                    chinese: '衣服',
                    image: 'images/fodoy.jpg',
                    audio_word: 'audio/fodoy.wav',
                    audio_sentence: 'audio/sentence_fodoy.wav'
                },
                {
                    id: 'sapad',
                    name: 'sapad',
                    chinese: '桌子',
                    image: 'images/sapad.jpg',
                    audio_word: 'audio/sapad.wav',
                    audio_sentence: 'audio/sentence_sapad.wav'
                }
            ],
            // 通用音效
            common: {
                question_audio: 'audio/question_o_maan_kinian.wav'
            }
        };

        // ==========================================
        // 遊戲邏輯
        // ==========================================

        class Game {
            constructor() {
                this.studentName = "";
                this.score = 0;
                this.currentQuestionIndex = 0;
                this.questions = [];
                // 錄音相關變數
                this.mediaRecorder = null;
                this.audioChunks = [];
                this.audioBlob = null;
                this.audioUrl = null;
                this.isRecording = false;
                this.stream = null;
            }

            // 初始化並開始遊戲
            start() {
                const nameInput = document.getElementById('student-name');
                if (!nameInput.value.trim()) {
                    alert("請先輸入名字喔！");
                    return;
                }
                this.studentName = nameInput.value.trim();

                // 請求錄音權限 (為了第三階段)
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(stream => {
                            this.stream = stream;
                            this.startGameFlow();
                        })
                        .catch(err => {
                            console.error(err);
                            alert("為了進行口說練習，請允許麥克風權限。如果無法開啟，將無法進行第三階段。");
                            this.startGameFlow(); // 即使失敗也讓他們玩前兩關
                        });
                } else {
                    alert("瀏覽器不支援錄音，口說部分將無法使用。");
                    this.startGameFlow();
                }
            }

            startGameFlow() {
                this.score = 0;
                this.currentQuestionIndex = 0;
                this.updateScoreUI();
                
                // 顯示計分板
                document.getElementById('score-board').classList.remove('hidden');

                // 產生題目
                this.generateQuestions();
                
                // 切換介面
                this.showScreen('quiz-screen');
                this.nextQuestion();
            }

            // 產生所有題目
            generateQuestions() {
                // 第一部分題目 (3題): 聽音選圖
                const phase1 = assets.items.map(item => ({
                    type: 1,
                    correctItem: item,
                    distractor: this.getRandomDistractor(item)
                }));

                // 第二部分題目 (3題): 看圖選回答
                const phase2 = assets.items.map(item => ({
                    type: 2,
                    correctItem: item,
                    distractor: this.getRandomDistractor(item)
                }));

                // 第三部分題目 (3題): 口說錄音 (順序固定或隨機皆可，這裡用隨機)
                const phase3 = assets.items.map(item => ({
                    type: 3,
                    correctItem: item
                }));

                // 合併題目
                this.questions = [...this.shuffle(phase1), ...this.shuffle(phase2), ...this.shuffle(phase3)];
            }

            getRandomDistractor(correctItem) {
                const others = assets.items.filter(i => i.id !== correctItem.id);
                return others[Math.floor(Math.random() * others.length)];
            }

            shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            // 進行下一題
            nextQuestion() {
                if (this.currentQuestionIndex >= this.questions.length) {
                    this.endGame();
                    return;
                }

                const q = this.questions[this.currentQuestionIndex];
                const totalQ = this.questions.length;

                // 判斷題型切換介面
                if (q.type === 3) {
                    // 第三階段：口說
                    this.showScreen('speaking-screen');
                    document.getElementById('level-indicator').innerText = `第 ${this.currentQuestionIndex + 1} / ${totalQ} 題 (口說練習)`;
                    
                    // 設定口說題目
                    document.getElementById('sp-image').src = q.correctItem.image;
                    this.resetRecording();
                } else {
                    // 第一、二階段：選擇題
                    this.showScreen('quiz-screen');
                    const isPhase1 = q.type === 1;
                    document.getElementById('level-indicator').innerText = 
                        `第 ${this.currentQuestionIndex + 1} / ${totalQ} 題 (${isPhase1 ? '聽音選圖' : '聽問句選回答'})`;

                    this.renderQuiz(q);
                }
            }

            // 渲染選擇題 (Phase 1 & 2)
            renderQuiz(q) {
                const qArea = document.getElementById('question-area');
                qArea.innerHTML = '';
                const isPhase1 = q.type === 1;

                if (isPhase1) {
                    qArea.innerHTML = `
                        <button onclick="game.playAudio('${q.correctItem.audio_word}')" class="btn-audio w-24 h-24 rounded-full flex flex-col items-center justify-center text-2xl shadow-lg transition-transform hover:scale-105">
                            <i class="fa-solid fa-volume-high mb-1"></i>
                            <span class="text-xs font-bold">播放</span>
                        </button>
                        <p class="mt-4 text-gray-500 text-sm">點擊按鈕聽聲音，選出正確圖片</p>
                    `;
                } else {
                    qArea.innerHTML = `
                        <div class="w-full max-w-xs mb-4">
                            <img src="${q.correctItem.image}" alt="Question Image" class="game-img" onerror="this.onerror=null; this.src=''; this.parentElement.innerHTML='<div class=\'img-placeholder\'>${q.correctItem.chinese}</div>'">
                        </div>
                        <button onclick="game.playAudio('${assets.common.question_audio}')" class="bg-gray-800 text-white px-6 py-2 rounded-full text-sm hover:bg-black transition">
                            <i class="fa-solid fa-ear-listen mr-2"></i> 聽問題 (O maan kinian?)
                        </button>
                    `;
                }

                const optArea = document.getElementById('options-area');
                optArea.innerHTML = '';
                const options = this.shuffle([q.correctItem, q.distractor]);

                options.forEach((opt, index) => {
                    const isCorrect = (opt.id === q.correctItem.id);
                    const btn = document.createElement('div');
                    btn.className = "btn-option bg-white border-4 border-gray-100 rounded-xl p-4 flex flex-col items-center justify-center shadow-sm h-48 relative transition-all";
                    
                    if (isPhase1) {
                        btn.classList.add('btn-option-clickable', 'hover:border-red-400');
                        btn.innerHTML = `
                            <img src="${opt.image}" class="w-full h-full object-contain pointer-events-none" alt="${opt.chinese}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="img-placeholder hidden absolute inset-0 m-4 text-2xl pointer-events-none">${opt.chinese}</div>
                        `;
                        btn.onclick = () => {
                            this.playAudio(opt.audio_word);
                            this.checkAnswer(isCorrect);
                        };
                    } else {
                        btn.innerHTML = `
                             <button class="mb-2 w-16 h-16 bg-yellow-400 hover:bg-yellow-500 rounded-full flex items-center justify-center text-white text-2xl shadow-md transition-transform active:scale-95 btn-listen-${index}">
                                <i class="fa-solid fa-volume-high"></i>
                             </button>
                             <span class="text-xs text-gray-500 mb-2 font-bold">試聽</span>
                             <button class="bg-red-600 hover:bg-red-700 text-white rounded-full px-6 py-2 font-bold shadow-md transition-transform active:scale-95 btn-select-${index}">
                                <i class="fa-solid fa-check mr-1"></i> 選這個
                             </button>
                        `;
                        optArea.appendChild(btn);
                        
                        btn.querySelector(`.btn-listen-${index}`).onclick = (e) => { e.stopPropagation(); this.playAudio(opt.audio_sentence); };
                        btn.querySelector(`.btn-select-${index}`).onclick = (e) => { e.stopPropagation(); this.checkAnswer(isCorrect); };
                    }
                    if(isPhase1) optArea.appendChild(btn);
                });
            }

            // 檢查選擇題答案
            checkAnswer(isCorrect) {
                const overlay = document.getElementById('feedback-overlay');
                const icon = document.getElementById('feedback-icon');
                overlay.style.display = 'flex';
                
                if (isCorrect) {
                    this.score += 10;
                    this.updateScoreUI();
                    icon.className = 'fa-solid fa-circle-check text-green-500 fade-in';
                    document.getElementById('sfx-correct').play();
                } else {
                    icon.className = 'fa-solid fa-circle-xmark text-red-500 fade-in';
                    document.getElementById('sfx-wrong').play();
                }

                setTimeout(() => {
                    overlay.style.display = 'none';
                    this.currentQuestionIndex++;
                    this.nextQuestion();
                }, 1500);
            }

            // --- 口說邏輯 ---

            playCurrentSpeakingQuestion() {
                // 播放通用問句 "O maan kinian?"
                this.playAudio(assets.common.question_audio);
            }

            toggleRecording() {
                if (this.isRecording) this.stopRecording();
                else this.startRecording();
            }

            startRecording() {
                if(!this.stream) { alert("沒有麥克風權限"); return; }
                this.audioChunks = [];
                this.mediaRecorder = new MediaRecorder(this.stream);
                this.mediaRecorder.ondataavailable = event => this.audioChunks.push(event.data);
                this.mediaRecorder.onstop = () => {
                    this.audioBlob = new Blob(this.audioChunks, { type: 'audio/mp3' });
                    this.audioUrl = URL.createObjectURL(this.audioBlob);
                    
                    document.getElementById('sp-controls').classList.remove('hidden');
                    document.getElementById('btn-retry').classList.remove('hidden');
                    document.getElementById('btn-record').classList.add('hidden');
                    document.getElementById('sp-status-text').innerText = "錄音完成！";
                };
                this.mediaRecorder.start();
                this.isRecording = true;
                
                const btn = document.getElementById('btn-record');
                btn.innerHTML = '<i class="fa-solid fa-stop"></i>';
                btn.classList.add('recording-pulse', 'bg-gray-800');
                btn.classList.remove('bg-red-600');
                document.getElementById('sp-status-text').innerText = "正在錄音中...";
            }

            stopRecording() {
                this.mediaRecorder.stop();
                this.isRecording = false;
                const btn = document.getElementById('btn-record');
                btn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
                btn.classList.remove('recording-pulse', 'bg-gray-800');
                btn.classList.add('bg-red-600');
            }

            resetRecording() {
                this.audioBlob = null;
                this.audioUrl = null;
                document.getElementById('sp-controls').classList.add('hidden');
                document.getElementById('btn-retry').classList.add('hidden');
                document.getElementById('btn-record').classList.remove('hidden');
                document.getElementById('sp-status-text').innerText = "按住按鈕錄音回答";
            }

            playRecording() {
                if (!this.audioUrl) return;
                const player = document.getElementById('audio-player');
                player.src = this.audioUrl;
                player.play();
            }

            uploadRecording() {
                if (!this.audioBlob) return;
                this.showScreen('screen-loading');

                const reader = new FileReader();
                reader.readAsDataURL(this.audioBlob);
                reader.onloadend = () => {
                    const base64data = reader.result.split(',')[1];
                    // 檔名: 姓名_Q題號.mp3 (Q7, Q8, Q9 for continuity)
                    const fileName = `${this.studentName}_Q${this.currentQuestionIndex + 1}.mp3`;

                    fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            file: base64data,
                            fileName: fileName,
                            mimeType: this.audioBlob.type
                        })
                    })
                    .then(() => {
                        // 口說題只要上傳成功就給分 (配分: 第一題10, 第二題10, 第三題20, 共40分)
                        const isLast = this.currentQuestionIndex === this.questions.length - 1;
                        const points = isLast ? 20 : 10; 
                        this.score += points;
                        this.updateScoreUI();

                        setTimeout(() => {
                            this.currentQuestionIndex++;
                            this.nextQuestion();
                        }, 1000);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert("上傳失敗，請檢查網路。");
                        this.showScreen('speaking-screen');
                    });
                };
            }

            // --- 輔助功能 ---
            updateScoreUI() { document.getElementById('score-display').innerText = this.score; }
            playAudio(src) { 
                const p = document.getElementById('audio-player'); 
                p.src = src; 
                p.play().catch(e=>console.log(e)); 
            }
            
            showScreen(screenId) {
                ['screen-login', 'quiz-screen', 'speaking-screen', 'screen-loading', 'result-screen'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(screenId).classList.remove('hidden');
            }

            endGame() {
                this.showScreen('result-screen');
                const finalScore = document.getElementById('final-score');
                const feedbackText = document.getElementById('feedback-text');
                
                let currentDisplay = 0;
                const timer = setInterval(() => {
                    if (currentDisplay >= this.score) {
                        currentDisplay = this.score;
                        clearInterval(timer);
                    } else {
                        currentDisplay++;
                    }
                    finalScore.innerText = currentDisplay;
                }, 20);

                if (this.score === 100) feedbackText.innerText = "太厲害了！全部完成！Fangcalay!";
                else if (this.score >= 60) feedbackText.innerText = "做得很好！再接再厲！";
                else feedbackText.innerText = "加油！再試一次會更好！Saʼicelen!";
            }
        }

        const game = new Game();
        
        // 綁定錄音按鈕事件 (點擊切換錄音狀態)
        document.getElementById('btn-record').addEventListener('click', () => {
            game.toggleRecording();
        });

    </script>
</body>
</html>
